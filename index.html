<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Inversión Avanzado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #cbd5e1; }
        .card { background-color: #1e293b; border-radius: 0.75rem; border: 1px solid #334155; }
        .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .input-label { font-size: 0.875rem; color: #94a3b8; }
        .input-field {
            background-color: #334155; border: 1px solid #475569;
            color: #e2e8f0; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%;
        }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: #38bdf8; cursor: pointer; border-radius: 50%; border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer; background: #334155; border-radius: 5px;
        }
        .info-btn {
            background-color: #334155; color: #94a3b8; border-radius: 50%;
            width: 20px; height: 20px; font-weight: bold; font-size: 12px;
            display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background-color 0.2s; margin-left: 8px;
        }
        .info-btn:hover { background-color: #475569; color: #e2e8f0; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(10, 20, 30, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 50;
        }
        .modal-content {
            background-color: #1e293b; color: #cbd5e1; padding: 2rem; border-radius: 0.5rem;
            max-width: 500px; width: 90%; position: relative; border: 1px solid #334155;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; font-size: 24px; font-weight: bold; cursor: pointer; color: #9ca3af; }
        .calc-row { display: flex; justify-content: space-between; padding: 4px 0; }
        .calc-row.total { border-top: 1px solid #334155; font-weight: bold; padding-top: 8px; }
        .hidden { display: none; }
        .result-box { transition: background-color 0.3s ease-in-out; }
        .result-text-lg, .result-text-sm { transition: color 0.3s ease-in-out; }
        .bar { transition: width 0.5s ease-in-out, background-color 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-sky-400">Simulador de Inversión</h1>
            <p class="text-xl text-slate-400 mt-2">Análisis Comparativo Avanzado</p>
        </header>

        <!-- Panel de Configuración Global -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold text-slate-200 mb-4 text-center border-b border-slate-700 pb-3">Parámetros de la Simulación</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 pt-4">
                <div class="input-group">
                    <label for="investment-amount" class="input-label">Monto Inversión (CLP)</label>
                    <input type="number" id="investment-amount" class="input-field" value="50000000">
                    <p id="formatted-amount-display" class="text-xs text-slate-500 text-right h-4"></p>
                </div>
                <div class="input-group">
                    <label for="investment-period" class="input-label">Período (Años)</label>
                    <input type="number" id="investment-period" class="input-field" value="1" min="1">
                </div>
                <div class="input-group">
                    <label for="ipc-rate" class="input-label">IPC Anual (%)</label>
                    <input type="number" id="ipc-rate" class="input-field" value="4.0" step="0.1">
                </div>
                <div class="input-group">
                    <label for="tax-rate-dap" class="input-label">Impuesto Cliente (%)</label>
                    <input type="number" id="tax-rate-dap" class="input-field" value="15.57" step="0.01">
                </div>
            </div>
        </div>

        <!-- Paneles de Resultados -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Opción 1: DAP -->
            <div class="card p-6 flex flex-col">
                <h3 class="text-xl font-bold text-slate-200 mb-4 text-center">Opción 1: Depósito a Plazo</h3>
                <div class="space-y-4 flex-grow">
                    <div class="input-group">
                        <label for="dap-monthly-rate-slider" class="input-label text-center">Tasa Interés Mensual</label>
                        <p id="dap-monthly-rate-display" class="text-sky-400 text-xl text-center font-semibold">0.40%</p>
                        <input id="dap-monthly-rate-slider" type="range" min="0.1" max="1.5" value="0.4" step="0.01">
                    </div>
                    <div>
                        <p class="text-sm text-center text-slate-400">Interés Total del Período</p>
                        <p id="dap-total-period-interest" class="text-lg text-center font-semibold text-slate-100">4.91%</p>
                    </div>
                    <div class="flex items-center justify-center">
                        <p class="text-sm text-slate-400">Impuestos Totales</p>
                        <button id="dap-tax-info-btn" class="info-btn">!</button>
                    </div>
                    <p id="dap-tax-amount" class="text-lg font-semibold text-amber-400 text-center">-$0</p>
                </div>
                <div id="dap-result-box" class="mt-6 text-center bg-red-900/40 p-4 rounded-lg result-box">
                    <p id="dap-result-text-sm" class="text-sm result-text-sm">Ganancia Neta Final</p>
                    <p id="dap-net-gain" class="text-3xl font-bold result-text-lg">$0</p>
                </div>
            </div>

            <!-- Opción 2: Fondo -->
            <div class="card p-6 flex flex-col">
                <h3 class="text-xl font-bold text-slate-200 mb-4 text-center">Opción 2: Fondo Moneda Renta CLP</h3>
                <div class="space-y-4 flex-grow">
                     <div class="input-group">
                        <label for="fund-return-slider" class="input-label text-center">Rentabilidad Anual Esperada</label>
                        <p id="fund-return-display" class="text-sky-400 text-xl text-center font-semibold">10.1%</p>
                        <input id="fund-return-slider" type="range" min="3" max="15" value="10.1" step="0.1">
                    </div>
                    <div class="flex items-center justify-center">
                        <p class="text-sm text-slate-400">Descuentos Totales</p>
                        <button id="fund-deductions-info-btn" class="info-btn">!</button>
                    </div>
                    <p id="fund-deductions" class="text-lg font-semibold text-amber-400 text-center">-$0</p>
                </div>
                <div id="fund-result-box" class="mt-6 text-center bg-green-900/40 p-4 rounded-lg result-box">
                    <p id="fund-result-text-sm" class="text-sm result-text-sm">Ganancia Neta Final</p>
                    <p id="fund-net-gain" class="text-3xl font-bold result-text-lg">$0</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="dap-tax-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h4 class="font-bold text-lg mb-2 text-slate-100">Detalle de Impuestos (DAP)</h4>
            <div class="bg-slate-900 p-3 rounded mt-2 text-sm space-y-2">
                <div class="calc-row"><span>Ganancia Bruta Total</span><span id="dap-tax-modal-gross"></span></div>
                <div class="calc-row"><span>Ajuste por IPC</span><span id="dap-tax-modal-ipc"></span></div>
                <div class="calc-row total"><span>= Ganancia Imponible</span><span id="dap-tax-modal-taxable"></span></div>
                <div class="calc-row"><span>Impuesto Aplicado</span><span id="dap-tax-modal-tax-applied"></span></div>
                <div class="calc-row total"><span>Total Impuesto Pagado</span><span id="dap-tax-modal-total"></span></div>
            </div>
        </div>
    </div>
    <div id="fund-deductions-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h4 class="font-bold text-lg mb-2 text-slate-100">Detalle de Descuentos (Fondo)</h4>
            <div class="bg-slate-900 p-3 rounded mt-2 text-sm space-y-2">
                <div class="calc-row"><span>Costo Compra Sura (0.595%)</span><span id="fund-deductions-modal-entry"></span></div>
                <div class="calc-row"><span>Costo Venta Moneda (0.3%)</span><span id="fund-deductions-modal-exit-fund"></span></div>
                <div class="calc-row"><span>Advisory Fee (1% anual)</span><span id="fund-deductions-modal-advisory"></span></div>
                <div class="calc-row"><span>Costo Venta Sura (0.595%)</span><span id="fund-deductions-modal-exit-broker"></span></div>
                <div class="calc-row"><span>Impuesto (10% s/ganancia real)</span><span id="fund-deductions-modal-tax"></span></div>
                <div class="calc-row total"><span>= Total Descuentos</span><span id="fund-deductions-modal-total"></span></div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const investmentAmountInput = document.getElementById('investment-amount');
        const formattedAmountDisplay = document.getElementById('formatted-amount-display');
        const investmentPeriodInput = document.getElementById('investment-period');
        const ipcRateInput = document.getElementById('ipc-rate');
        const taxRateDapInput = document.getElementById('tax-rate-dap');
        
        const dapMonthlyRateSlider = document.getElementById('dap-monthly-rate-slider');
        const dapMonthlyRateDisplay = document.getElementById('dap-monthly-rate-display');
        const dapTotalPeriodInterestEl = document.getElementById('dap-total-period-interest');
        const dapTaxAmountEl = document.getElementById('dap-tax-amount');
        const dapNetGainEl = document.getElementById('dap-net-gain');
        const dapResultBox = document.getElementById('dap-result-box');
        const dapResultTextSm = document.getElementById('dap-result-text-sm');
        
        const fundReturnSlider = document.getElementById('fund-return-slider');
        const fundReturnDisplay = document.getElementById('fund-return-display');
        const fundDeductionsEl = document.getElementById('fund-deductions');
        const fundNetGainEl = document.getElementById('fund-net-gain');
        const fundResultBox = document.getElementById('fund-result-box');
        const fundResultTextSm = document.getElementById('fund-result-text-sm');

        const clpFormatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });

        function setupModal(buttonId, modalId) {
            const button = document.getElementById(buttonId);
            const modal = document.getElementById(modalId);
            if (!button || !modal) return;
            const closeBtn = modal.querySelector('.modal-close-btn');
            button.addEventListener('click', () => modal.classList.remove('hidden'));
            if(closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });
        }

        setupModal('dap-tax-info-btn', 'dap-tax-modal');
        setupModal('fund-deductions-info-btn', 'fund-deductions-modal');
        
        function updateUI() {
            // --- Get Global Values ---
            const initialInvestment = parseFloat(investmentAmountInput.value) || 0;
            const periodInYears = parseInt(investmentPeriodInput.value) || 1;
            const ipcRate = (parseFloat(ipcRateInput.value) || 0) / 100;
            const dapTaxRate = (parseFloat(taxRateDapInput.value) || 0) / 100;

            // Format investment amount for display
            formattedAmountDisplay.textContent = clpFormatter.format(initialInvestment);

            // --- DAP Calculation ---
            const dapMonthlyRate = parseFloat(dapMonthlyRateSlider.value) / 100;
            dapMonthlyRateDisplay.textContent = `${(dapMonthlyRate * 100).toFixed(2)}%`;
            
            const dapAnnualRate = Math.pow(1 + dapMonthlyRate, 12) - 1;
            const totalPeriodInterestRate = Math.pow(1 + dapAnnualRate, periodInYears) - 1;
            const dapGrossGain = initialInvestment * totalPeriodInterestRate;
            
            dapTotalPeriodInterestEl.textContent = `${(totalPeriodInterestRate * 100).toFixed(2)}%`;

            const dapInflationAdjustment = initialInvestment * (Math.pow(1 + ipcRate, periodInYears) - 1);
            const dapTaxableGain = Math.max(0, dapGrossGain - dapInflationAdjustment);
            const dapTaxAmount = dapTaxableGain * dapTaxRate;
            const dapNetGain = dapGrossGain - dapTaxAmount;
            
            dapTaxAmountEl.textContent = `-${clpFormatter.format(dapTaxAmount)}`;
            dapNetGainEl.textContent = clpFormatter.format(dapNetGain);

            // DAP Modal Update
            document.getElementById('dap-tax-modal-gross').textContent = clpFormatter.format(dapGrossGain);
            document.getElementById('dap-tax-modal-ipc').textContent = `-${clpFormatter.format(dapInflationAdjustment)}`;
            document.getElementById('dap-tax-modal-taxable').textContent = clpFormatter.format(dapTaxableGain);
            document.getElementById('dap-tax-modal-tax-applied').textContent = `-${clpFormatter.format(dapTaxAmount)}`;
            document.getElementById('dap-tax-modal-total').textContent = `-${clpFormatter.format(dapTaxAmount)}`;

            // --- Fund Calculation ---
            const fundReturnRate = parseFloat(fundReturnSlider.value) / 100;
            fundReturnDisplay.textContent = `${(fundReturnRate * 100).toFixed(1)}%`;
            const fundTaxRate = 0.10;
            
            const entryFee = initialInvestment * 0.00595;
            const investedCapital = initialInvestment - entryFee;
            let grossCapitalInFund = investedCapital;
            // The advisory fee is annual, so we need to calculate it inside the loop
            let cumulativeAdvisoryFee = 0;
            for (let i = 0; i < periodInYears; i++) {
                grossCapitalInFund *= (1 + fundReturnRate);
                cumulativeAdvisoryFee += grossCapitalInFund * 0.01;
                grossCapitalInFund -= grossCapitalInFund * 0.01;
            }

            const exitFeeFund = grossCapitalInFund * 0.003;
            const capitalAfterFundFee = grossCapitalInFund - exitFeeFund;
            const exitFeeBroker = capitalAfterFundFee * 0.00595;
            const liquidCapital = capitalAfterFundFee - exitFeeBroker;
            
            const initialAdjustedCapital = initialInvestment * Math.pow(1 + ipcRate, periodInYears);
            const fundTaxableGain = Math.max(0, liquidCapital - initialAdjustedCapital);
            const fundTaxAmount = fundTaxableGain * fundTaxRate;
            const fundNetGain = liquidCapital - initialInvestment - fundTaxAmount;
            const totalDeductions = entryFee + exitFeeFund + cumulativeAdvisoryFee + exitFeeBroker + fundTaxAmount;
            
            fundDeductionsEl.textContent = `-${clpFormatter.format(totalDeductions)}`;
            fundNetGainEl.textContent = clpFormatter.format(fundNetGain);

            // Fund Modal Update
            document.getElementById('fund-deductions-modal-entry').textContent = `-${clpFormatter.format(entryFee)}`;
            document.getElementById('fund-deductions-modal-exit-fund').textContent = `-${clpFormatter.format(exitFeeFund)}`;
            document.getElementById('fund-deductions-modal-advisory').textContent = `-${clpFormatter.format(cumulativeAdvisoryFee)}`;
            document.getElementById('fund-deductions-modal-exit-broker').textContent = `-${clpFormatter.format(exitFeeBroker)}`;
            document.getElementById('fund-deductions-modal-tax').textContent = `-${clpFormatter.format(fundTaxAmount)}`;
            document.getElementById('fund-deductions-modal-total').textContent = `-${clpFormatter.format(totalDeductions)}`;

            // --- Color Inversion Logic ---
            const dapIsWinner = dapNetGain > fundNetGain;
            const winnerClasses = { box: 'bg-green-900/40', textSm: 'text-green-300', textLg: 'text-green-400' };
            const loserClasses = { box: 'bg-red-900/40', textSm: 'text-red-300', textLg: 'text-red-400' };
            const dapStyles = dapIsWinner ? winnerClasses : loserClasses;
            const fundStyles = dapIsWinner ? loserClasses : winnerClasses;

            dapResultBox.className = `mt-6 text-center p-4 rounded-lg result-box ${dapStyles.box}`;
            dapResultTextSm.className = `text-sm result-text-sm ${dapStyles.textSm}`;
            dapNetGainEl.className = `text-3xl font-bold result-text-lg ${dapStyles.textLg}`;

            fundResultBox.className = `mt-6 text-center p-4 rounded-lg result-box ${fundStyles.box}`;
            fundResultTextSm.className = `text-sm result-text-sm ${fundStyles.textSm}`;
            fundNetGainEl.className = `text-3xl font-bold result-text-lg ${fundStyles.textLg}`;
        }

        // --- Event Listeners ---
        const inputs = [investmentAmountInput, investmentPeriodInput, ipcRateInput, taxRateDapInput, dapMonthlyRateSlider, fundReturnSlider];
        inputs.forEach(input => input.addEventListener('input', updateUI));

        // --- Initial Load ---
        window.addEventListener('load', updateUI);
    </script>
</body>
</html>